package JcoTest;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.OutputStreamWriter;
import java.util.Properties;

import com.sap.conn.jco.JCoDestination;
import com.sap.conn.jco.JCoDestinationManager;
import com.sap.conn.jco.JCoException;
import com.sap.conn.jco.JCoFunction;
import com.sap.conn.jco.ext.DestinationDataProvider;

public class FirstJcoTest {
	static String ABAP_AS = "ABAP_AS_WITHOUT_POOL";  // SAP 연결명

    // SAP 연결 구성 파일 생성 메서드
    static void createDestinationDataFile(String destinationName, Properties connectProperties) {
        // 연결 설정 파일 생성
        File destCfg = new File(destinationName + ".jcoDestination");
        if (!destCfg.exists()) {
            try (OutputStreamWriter writer = new OutputStreamWriter(new FileOutputStream(destCfg, false), "UTF-8")) {
                connectProperties.store(writer, "for tests only!");
            } catch (IOException e) {
                throw new RuntimeException("Unable to create the destination files", e);
            }
        }
    }

    public static void getTextFromSap() throws JCoException {
        System.out.println("SAP로부터 데이터 가져오기");

        // SAP 연결 생성
        JCoDestination destination = JCoDestinationManager.getDestination(ABAP_AS);

        // 연결 정보 출력 (테스트용)
        System.out.println("Attributes:");
        System.out.println(destination.getAttributes());
        System.out.println();

        // 원격 펑션 모듈 호출
        JCoFunction function = destination.getRepository().getFunction("ZABAP_047_JCOTEST");
        if (function == null) {
            throw new RuntimeException("RFC Function not found in SAP.");
        }

        // 함수 실행
        try {
            function.execute(destination);
            System.out.println("RFC 함수 실행 완료!");

            // SAP에서 Export 파라미터로 전달된 텍스트 데이터 가져오기
            String exportText = function.getExportParameterList().getString("TEXT");
            System.out.println("SAP로부터 받은 데이터: " + exportText);

        } catch (JCoException e) {
            System.out.println("RFC 실행 중 오류 발생: " + e.getMessage());
        }
    }

    public static void main(String[] args) {
        System.out.println("SAP JCo 연결 시작");

        // 연결 프로퍼티 생성
        Properties connectProperties = new Properties();
        connectProperties.setProperty(DestinationDataProvider.JCO_ASHOST, "AB4.UCC.UWM.EDU");  // SAP 호스트 정보
        connectProperties.setProperty(DestinationDataProvider.JCO_SYSNR, "00");  // 인스턴스 번호
        connectProperties.setProperty(DestinationDataProvider.JCO_CLIENT, "519");  // SAP 클라이언트
        connectProperties.setProperty(DestinationDataProvider.JCO_USER, "ZU-047");  // SAP 유저명
        connectProperties.setProperty(DestinationDataProvider.JCO_PASSWD, "@dlagorms1");  // SAP 패스워드
        connectProperties.setProperty(DestinationDataProvider.JCO_LANG, "EN");  // 언어

        // 연결 파일 생성
        createDestinationDataFile(ABAP_AS, connectProperties);

        // SAP에서 데이터 가져오기 실행
        try {
            getTextFromSap();
        } catch (JCoException e) {
            System.out.println("SAP 연결 또는 데이터 조회 중 오류 발생: " + e.getMessage());
        }
    }
}